# The Serial Commutator (SC) FFT

## Описание

Имплементация вычисления БПФ методом Serial Commutator предложенной в [данной научной статье](/docs/fft_sc.pdf).

Данная реализация построена по конвеерному принципу и позволяет синтезировать проект под любое количество отсчетов N_FFT (где N_FFT = power(2, k)).

## Архитектура

![arch](/pics/arch.png)

- _fft_sc_ - компонент верхнего уровня, для встраивания в проект
- _reorder_ - компонент для перестановки данных между вычислительными стадиями
- _out_reorder_ - компонент для приведения порядка следования данных к нормальному виду
- _stage_ - вычислительная стадия FFT
- _butterfly_ - операция "бабочка"
- _proc_elem_ - вычислительный элемент
- _rotator_ - компонент умножения данных на поворачивающие множители
- _twid_idx_gen_ - генератор индексов доступа к массиву поворачивающих множителей
- _twiddles_gen_ - массив поворачивающих множителей, полученный с помощью скрипта _create_twiddles.py_

## Подключение к проекту (Quartus Prime)

Для подключения компонента fft_sc к проекту необходимо в qsf файле проекта добавить следующую строку:
`set_global_assignment -name QIP_FILE path/to/fft_sc.qip`.

Компонент добавляется как часть библиотеки fft_sc_lib, поэтому в случае использования языка VHDL, эту библиотеку необходимо объявить, прежде чем подключать компонент fft_sc:

```vhdl
library fft_sc_lib;

...

fft_sc_inst : entity fft_sc_lib.fft_sc
  generic map (
    FFT_SIZE => FFT_SIZE        -- Кол-во отсчетов FFT (FFT_SIZE = 2^k, где k = 4,5,6,...N)
  )
  port map (
    clk         => clk,         -- Тактовая частота
    din_re      => din_re,      -- Входные данные (вещественная часть)
    din_im      => din_im,      -- Входные данные (мнимая часть)
    din_valid   => din_valid,   -- Сигнал валидности входных данных
    dout_re     => dout_re,     -- Выходные данные (вещественная часть)
    dout_im     => dout_im,     -- Выходные данные (мнимая часть)
    dout_valid  => dout_valid   -- Сигнал валидности выходных данных
  );
```

Прежде чем начинать синтез (или симуляцию) проекта, необходимо, с помощью утилиты _create_twiddles.py_ сгенерировать массив поворотных коэффициентов. При запуске утилиты, необходимо в нее передать следующие аргументы: количество отсчетов FFT (size) и путь где утилита должна создать файл _twiddles_gen.sv_. Пример для size=1024:
```shell
python create_twiddles.py --size=1024 --filepath=rtl
```

## Симуляция (Modelsim)
### Проведение симуляции
1. Запустить Matlab
2. Перейти в директорию sim
3. Создать массив данных (in.txt) для подачи на вход компонента _fft_sc_.Для этого необходимо выполнить скрипт _setdata.m_.
4. Запустить Modelsim
5. Перейти в директорию sim/modelsim
6. Запустить скрипт run_tb.tcl (`source ../run_tb.tcl`), предварительно поменяв в нем переменную _QUARTUS_INSTALL_DIR_
7. Дождаться окончания симуляции. По завершению симуляции Modelsim создаст файл _out.txt_, в котором записаны результаты расчета FFT
8. Для просмотра результатов симуляции, выполнить в Matlab скрипт _fftsc.m_

### Результаты симуляции
На скриншоте показан результат симуляции Modelsim (период тактовой частоты 10 нс):
![modelsim](/pics/modelsim.PNG)

На скриншоте показаны результаты расчета FFT из входных данных (Figure 2) и FFT построенное из результатов симуляции (Figure 3). Видно, что присутствуют некоторые шумы, обусловленные ошибками округления:
![fft_result](/pics/matlab_fft.PNG)

На скриншоте показан результат вычисления влияния ошибок округления на результирующий спектр:
![fft_error](/pics/matlab_fft_error.PNG)

Вышеприведенные результаты симуляции получены при следующих параметрах:
- N_FFT = 1024
- Входной сигнал представлял собой две гармоники расположенные рядом друг с другом
- Амплитуда гармоник равна 8192
- Вносимые шумы во входном сигнале отсутствовали

## Результаты синтеза

Синтез проводился при N_FFT = 1024

![synth](/pics/synth.PNG)


## Временные ограничения

Получающаяся при синтезе (N_FFT = 1024) максимальная тактовая частота равна 55 МГц. Что является далеко не впечатляющим параметром и не соответствует значениям из [статьи](/docs/fft_sc.pdf). Но данного значения вполне достаточно для многих применений. В будущем необходимо заняться оптимизированием исходного кода для получения более высоких значений максимальной тактовой частоты.

![fmax](/pics/fmax.PNG)

